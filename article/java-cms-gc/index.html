<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.9.0">
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content>
    <meta name="keyword" content>
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css">
    <script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>

    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <title>
        
          Java垃圾回收详解(4) - 西木 | Blog
        
    </title>

    <link rel="canonical" href="http://yoursite.com/article/java-cms-gc/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS --> 
    <link rel="stylesheet" href="/css/beantech.min.css">

    <link rel="stylesheet" href="/css/donate.css">

    <link rel="stylesheet" href="/css/search.css">
    
    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <link rel="stylesheet" href="/css/widget.css">

    <link rel="stylesheet" href="/css/rocket.css">

    <link rel="stylesheet" href="/css/signature.css">

    <link rel="stylesheet" href="/css/toc.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script>hljs.initHighlightingOnLoad();</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- hexo-inject:begin --><!-- hexo-inject:end --><!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('/img/header_img/archive.jpg')
            /*post*/
        
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#JAVA" title="JAVA">JAVA</a>
                            
                              <a class="tag" href="/tags/#JVM" title="JVM">JVM</a>
                            
                              <a class="tag" href="/tags/#垃圾回收篇" title="垃圾回收篇">垃圾回收篇</a>
                            
                        </div>
                        <h1>Java垃圾回收详解(4)</h1>
                        <h2 class="subheading">CMS 垃圾回收器详解之一 CMS 处理流程</h2>
                        <span class="meta">
                            Posted by Jason Lee on
                            2020-08-10
                        </span>
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">西木凌萧</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h2><span id="cms-垃圾回收器简介">CMS 垃圾回收器简介</span></h2><p>由于上一篇博文已经详细介绍了，这里就不在赘述，有兴趣可以围观一下<a href="https://icefrozen.github.io/article/Java-garbage-collection-analysis-2/" target="_blank" rel="noopener">Java垃圾回收详解(2)<br>GC方式介绍</a></p>
<p>这里做一个简单的回顾:</p>
<ul>
<li><p>获取最短回收停顿时间为目标的多线程并发收集器</p>
</li>
<li><p>cms 只会回收老年代和永久带（1.8开始为元数据区，需要设置- <code>CMSClassUnloadingEnabled</code>, <strong>不会收集年轻带</strong>；</p>
</li>
<li><p>cms 是一种预处理垃圾回收器，它不能等到old内存用尽时回收，需要在内存用尽前，完成回收操作，否则会导致并发回收失败；所以cms垃圾回收器开始执行回收操作，有一个触发阈值，默认是老年代或永久带达到<strong>92%</strong>；</p>
</li>
</ul>
<h2><span id="cms-过程详解">CMS 过程详解</span></h2><h2><span id="cms收集器的7个阶段">CMS收集器的7个阶段：</span></h2><ul>
<li>初始标记（CMS initial mark）  </li>
<li>并发标记（CMS concurrent mark）  </li>
<li>并发预清理（CMS concurrent-preclean）  </li>
<li>并发可取消的预清理 （CMS concurrent-abortable-preclean）  </li>
<li>重新标记（CMS remark）  </li>
<li>并发清除（CMS concurrent sweep）  </li>
<li><p>并发重置（CMS concurrent-reset）</p>
</li>
<li><p>流程大致如下<br><img src="/article/java-cms-gc/1552636690413java-cms-gc_.png" alt></p>
</li>
</ul>
<ul>
<li>具体过程如下<br><img src="/article/java-cms-gc/1552636737931java-cms-gc_.png" alt></li>
</ul>
<h2><span id="cms-阶段详解">CMS 阶段详解</span></h2><h3><span id="初始标记idling阶段">初始标记（Idling）阶段</span></h3><p>这是CMS中两次stop-the-world事件中的一次。这一步的作用是标记存活的对象，有两部分： </p>
<ol>
<li>标记老年代中所有的<code>GC Roots</code>对象，如下图节点1； </li>
<li>标记年轻代中活着的对象引用到的老年代的对象（指的是年轻带中还存活的引用类型对象，引用指向老年代中的对象）如下图节点2、3；<br><img src="/article/java-cms-gc/1552640918028java-cms-gc_.png" alt></li>
</ol>
<p>在Java语言里，可作为<a href="https://icefrozen.github.io/article/Java-garbage-collection-analysis-3/" target="_blank" rel="noopener">GC Roots对象</a>的包括如下几种： </p>
<ol>
<li>虚拟机栈(栈桢中的本地变量表)中的引用的对象 ； </li>
<li>方法区中的类静态属性引用的对象 ； </li>
<li>方法区中的常量引用的对象 ； </li>
<li>本地方法栈中JNI的引用的对象； </li>
</ol>
<p><strong><em>为了加快此阶段处理速度，减少停顿时间，可以开启初始标记并行化，<code>-XX:+CMSParallelInitialMarkEnabled</code>，同时调大并行标记的线程数，线程数不要超过cpu的核数</em></strong></p>
<h3><span id="并发标记-initialmarking阶段">并发标记 （InitialMarking）阶段</span></h3><p>从“初始标记”阶段标记的对象开始找出所有存活的对象,也就是从<code>GC_ROOTS</code> 触发，标记所有存活对象，由于第一次的结果，所以这次的标记并<strong>不需要STW</strong>。</p>
<p><strong>因为是并发运行的，在运行期间会发生新生代的对象晋升到老年代、或者是直接在老年代分配对象、或者更新老年代对象的引用关系等等，对于这些对象，都是需要进行重新标记的</strong>。</p>
<p>否则有些对象就会被遗漏，发生漏标的情况。为了提高重新标记的效率，该阶段会把上述对象所在的Card标识为Dirty，后续只需扫描这些Dirty Card的对象，避免扫描整个老年代；<br>并发标记阶段只负责将引用发生改变的Card标记为Dirty状态，不负责处理；</p>
<p>如下图所示，也就是节点1、2、3，最终找到了节点4和5。并发标记的特点是和应用程序线程同时运行。并不是老年代的所有存活对象都会被标记，因为标记的同时应用程序会改变一些对象的引用等。<br><img src="/article/java-cms-gc/1552641393363java-cms-gc_.png" alt><br>最后将6标记为存活,如下图所示：<br><img src="/article/java-cms-gc/1552641923916java-cms-gc_.png" alt></p>
<ul>
<li><strong>Card Table 是什么</strong></li>
</ul>
<blockquote>
<p>HotSpot 的一项叫做卡表（Card Table）的技术。该技术将整个堆划分为一个个大小为 512 字节的卡，并且维护一个卡表，用来存储每张卡的一个标识位。这个标识位代表对应的卡是否可能存有指向新生代对象的引用。如果可能存在，那么我们就认为这张卡是脏的。在进行 Minor GC 的时候，我们便可以不用扫描整个老年代，而是在卡表中寻找脏卡，并将脏卡中的对象加入到 Minor GC 的 GC Roots 里。当完成所有脏卡的扫描之后，Java 虚拟机便会将所有脏卡的标识位清零。</p>
</blockquote>
<h3><span id="预清理-precleaning-阶段">预清理 （Precleaning） 阶段</span></h3><p>通过参数 <code>CMSPrecleaningEnabled</code> 选择关闭该阶段，默认启用，主要做两件事情：</p>
<ol>
<li><p>处理新生代已经发现的引用，比如在并发阶段，在Eden区中分配了一个A对象，A对象引用了一个老年代对象B（这个B之前没有被标记），在这个阶段就会标记对象B为活跃对象。</p>
</li>
<li><p>在并发标记阶段，如果老年代中有对象内部引用发生变化，会把所在的Card标记为Dirty，然后扫描这些dirty card</p>
</li>
</ol>
<h3><span id="可中断的预清理abortablepreclean阶段">可中断的预清理（AbortablePreclean）阶段</span></h3><p>该阶段发生是有前提的：</p>
<ul>
<li><p>CMS 由于是在老年代垃圾扫描，但是大部分的老年代对象都是被 <code>GC_ROOTS</code> 引用的，如上图的 current obj 这个对象，虽然在老年代，但是其引用还是在年轻带，并且在并发标记阶段，也有可能老年代的某些对象别重新被新生代的对象重新引用。所以在gc的时候<strong>不仅需要扫描老年代也需要扫描新生代确定 <code>GC_ROOTS</code></strong> 。</p>
</li>
<li><p>全量的扫描新生代和老年代会不会很慢？肯定会,CMS 号称是停顿时间最短的GC，如此长的停顿时间肯定是不能接受的。 生代Eden区的内存使用量大于参数<code>CMSScheduleRemarkEdenSizeThreshold</code> 默认是2M，如果新生代的对象太少，就没有必要执行该阶段，直接执行重新标记阶段。</p>
</li>
<li><p>如果新生代很多，超过了上述的阈值,如果在扫描新生代前进行一次Minor GC，那么在下一阶段remard的时候，新生代的对象会很少，从而节省很多时间。</p>
</li>
<li><p>CMS 有两个参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CMSScheduleRemarkEdenSizeThreshold</span><br><span class="line">CMSScheduleRemarkEdenPenetration</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>默认值分别是2M、50%。两个参数组合起来的意思是预清理后，eden空间使用超过2M时启动可中断的并发预清理（<code>CMS-concurrent-abortable-preclean</code>），直到eden空间使用率达到50%时中断，进入remark阶段。</p>
<ul>
<li><p>如果能在可中止的预清理阶段发生一次 Minor GC,那就万事大吉、天下太平了。 这里有一个小问题,可终止的预清理要执行多长时间来保证发生一次Minor GC?答案是没法保证。道理很简单，因为垃圾回收是JVM自动调度的,什么时候进行GC我们控制不了。但此阶段总有一个执行时间吧？是的。</p>
</li>
<li><p>CMS提供了一个参数<code>CMSMaxAbortablePrecleanTime</code> ，默认为5S。只要到了5S，不管发没发生Minor GC，有没有到<code>CMSScheduleRemardEdenPenetration</code>都会中止此阶段，进入remark。如果在5S内还是没有执行Minor GC怎么办？CMS提供<code>CMSScavengeBeforeRemark</code>参数，使remark前强制进行一次Minor GC。</p>
</li>
</ul>
<p>这样做利弊都有。好的一面是减少了remark阶段的停顿时间;坏的一面是Minor GC后紧跟着一个remark pause。如此一来，停顿时间也比较久。</p>
<p>我们来结合日志来看一下这个阶段<br>CMS日志如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">7688.150</span>: [CMS-concurrent-preclean-start]</span><br><span class="line"></span><br><span class="line"><span class="number">7688.186</span>: [CMS-concurrent-preclean: <span class="number">0.034</span>/<span class="number">0.035</span> secs]</span><br><span class="line"></span><br><span class="line"><span class="number">7688.186</span>: [CMS-concurrent-abortable-preclean-start]</span><br><span class="line"></span><br><span class="line"><span class="number">7688.465</span>: [GC <span class="number">7688.465</span>: [ParNew: <span class="number">1040940</span>K-&gt;<span class="number">1464</span>K(<span class="number">1044544</span>K), <span class="number">0.0165840</span> secs] <span class="number">1343593</span>K-&gt;<span class="number">304365</span>K(<span class="number">2093120</span>K), </span><br><span class="line"></span><br><span class="line"><span class="number">0.0167509</span> secs]<span class="number">7690.093</span>: [CMS-concurrent-abortable-preclean: <span class="number">1.012</span>/<span class="number">1.907</span> secs]  <span class="number">7690.095</span>: [GC[YG occupancy: <span class="number">522484</span> K (<span class="number">1044544</span> K)]</span><br><span class="line"></span><br><span class="line"><span class="number">7690.095</span>: [Rescan (parallel) , <span class="number">0.3665541</span> secs]<span class="number">7690.462</span>: [weak refs processing, <span class="number">0.0003850</span> secs] [<span class="number">1</span> CMS-remark: <span class="number">302901</span>K(<span class="number">1048576</span>K)] <span class="number">825385</span>K(<span class="number">2093120</span>K), <span class="number">0.3670690</span> secs]</span><br></pre></td></tr></table></figure></p>
<p>7688.186启动了可终止的预清理，在随后的三秒内启动了Minor GC，然后进入了Remark阶段.实际上为了减少remark阶段的STW时间</p>
<h3><span id="重新标记finalmarking">重新标记（FinalMarking）</span></h3><p>这个阶段会导致第二次stop the word，该阶段的任务是完成标记整个年老代的所有的存活对象。<br>这个阶段，重新标记的内存范围是整个堆，包含_young_gen和_old_gen。为什么要扫描新生代呢，因为对于老年代中的对象，如果被新生代中的对象引用，那么就会被视为存活对象，即使新生代的对象已经不可达了，也会使用这些不可达的对象当做cms的“gc root”，来扫描老年代； 因此对于老年代来说，引用了老年代中对象的新生代的对象，也会被老年代视作“GC ROOTS”:当此阶段耗时较长的时候，可以加入参数<code>-XX:+CMSScavengeBeforeRemark</code>，在重新标记之前，先执行一次ygc，回收掉年轻带的对象无用的对象，并将对象放入幸存带或晋升到老年代，这样再进行年轻带扫描时，只需要扫描幸存区的对象即可，一般幸存带非常小，这大大减少了扫描时间。<br>由于之前的预处理阶段是与用户线程并发执行的，这时候可能年轻带的对象对老年代的引用已经发生了很多改变，这个时候，remark阶段要花很多时间处理这些改变，会导致很长stop the word，所以通常CMS尽量运行Final Remark阶段在年轻代是足够干净的时候。</p>
<p>另外，还可以开启并行收集：-XX:+CMSParallelRemarkEnabled</p>
<h3><span id="并发清理-cms-concurrent-sweep">并发清理 （ CMS-concurrent-sweep ）</span></h3><p>这个阶段的目的就是移除那些不用的对象，回收他们占用的空间并且为将来使用。注意这个阶段会产生新的垃圾，新的垃圾在此次GC无法清除，只能等到下次清理。这些垃圾有个专业名词：浮动垃圾。</p>
<h3><span id="并发重置-cms-concurrent-reset">并发重置 （ CMS-concurrent-reset ）</span></h3><p>这个阶段并发执行，重新设置CMS算法内部的数据结构，准备下一个CMS生命周期的使用。</p>
<h2><span id="cms-调优">CMS 调优</span></h2><h2><span id="cms-jvm-参数">CMS JVM 参数</span></h2><div class="table-container">
<table>
<thead>
<tr>
<th>参数名</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>-XX:+<code>PrintCommandLineFlags</code></td>
<td style="text-align:left">打印出启动参数行</td>
</tr>
<tr>
<td>-XX:+<code>UseConcMarkSweepGC</code></td>
<td style="text-align:left">参数指定使用CMS垃圾回收器</td>
</tr>
<tr>
<td>-XX:+<code>UseCMSInitiatingOccupancyOnly</code></td>
<td style="text-align:left">命令JVM不基于运行时收集的数据来启动CMS垃圾收集周期。而是，当该标志被开启时，JVM通过 <code>CMSInitiatingOccupancyFraction</code> 的值进行每一次CMS收集，而不仅仅是第一次。然而，请记住大多数情况下，JVM比我们自己能作出更好的垃圾收集决策。因此，只有当我们充足的理由(比如测试)并且对应用程序产生的对象的生命周期有深刻的认知时，才应该使用该标志。</td>
</tr>
<tr>
<td>-XX:<code>CMSInitiatingOccupancyFraction</code>=80</td>
<td style="text-align:left">参数指定CMS垃圾回收器在老年代达到80%的时候开始工作，如果不指定那么默认的值为92%</td>
</tr>
<tr>
<td>-XX:+<code>CMSClassUnloadingEnabled</code></td>
<td style="text-align:left">开启永久带（jdk1.8以下版本）或元数据区（jdk1.8及其以上版本）收集，如果没有设置这个标志，一旦永久代或元数据区耗尽空间也会尝试进行垃圾回收，但是收集不会是并行的，而再一次进行Full GC</td>
</tr>
<tr>
<td>-XX:+<code>UseParNewGC</code></td>
<td style="text-align:left">使用cms时默认这个参数就是打开的，不需要配置，cms只回收老年代，年轻带只能配合Parallel New或Serial回收器；</td>
</tr>
<tr>
<td>-XX:+<code>CMSParallelRemarkEnabled</code></td>
<td style="text-align:left">减少Remark阶段暂停的时间，启用并行Remark，如果Remark阶段暂停时间长，可以启用这个参数  用于重新标记阶段是否采用多线程并行执行</td>
</tr>
<tr>
<td>-XX:+CMSScavengeBeforeRemark</td>
<td style="text-align:left">若Remark阶段暂停时间太长，可以启用这个参数，在Remark执行之前，先做一次ygc。因为这个阶段，年轻带也是cms的gcroot，cms会扫描年轻带指向老年代对象的引用，如果年轻带有大量引用需要被扫描，会让Remark阶段耗时增加</td>
</tr>
<tr>
<td>-XX:<code>CMSFullGCsBeforeCompaction</code>=0 <br>-XX:+<code>UseCMSCompactAtFullCollection</code></td>
<td style="text-align:left">两个参数是针对cms垃圾回收器碎片做优化的，CMS是不会移动内存的， 运行时间长了，会产生很多内存碎片， 导致没有一段连续区域可以存放大对象，出现<code>promotion failed</code>、<code>concurrent mode failure</code>, 导致fullgc，启用<code>UseCMSCompactAtFullCollection</code> 在FULL GC的时候， 对年老代的内存进行压缩。<code>-XX:CMSFullGCsBeforeCompaction=0</code> 则是代表多少次FGC后对老年代做压缩操作，默认值为0，代表每次都压缩, 把对象移动到内存的最左边，可能会影响性能,但是可以消除碎片,这两个错误会在后面的章节中详细介绍</td>
</tr>
<tr>
<td>-XX:+<code>CMSConcurrentMTEnabled</code> <br> -XX:<code>ConcGCThreads</code>=4</td>
<td style="text-align:left">定义并发CMS过程运行时的线程数。比如value=4意味着CMS周期的所有阶段都以4个线程来执行。尽管更多的线程会加快并发CMS过程，但其也会带来额外的同步开销。因此，对于特定的应用程序，应该通过测试来判断增加CMS线程数是否真的能够带来性能的提升。如果未设置这个参数，JVM会根据并行收集器中的<code>-XX:ParallelGCThreads</code>参数的值来计算出默认的并行CMS线程数,此字段如果不清楚的情况下不要设置<br><code>ParallelGCThreads = (ncpus &lt;=8 ? ncpus : 8+(ncpus-8)*5/8)</code>(ncpus为cpu个数)<br><code>ConcGCThreads =(ParallelGCThreads + 3)/4</code></td>
</tr>
<tr>
<td>-XX:+<code>ExplicitGCInvokesConcurrent</code> <br>-XX:+<code>ExplicitGCInvokesConcurrentAndUnloadsClasses</code></td>
<td style="text-align:left">开启foreground CMS GC，CMS gc 有两种模式，background和foreground，正常的cms gc使用background模式，就是我们平时说的cms gc；当并发收集失败或者调用了System.gc()的时候，就会导致一次full gc，这个fullgc是不是cms回收，而是Serial单线程回收器，加入了参数<code>-XX:+ExplicitGCInvokesConcurrent</code>后，执行full gc的时候，就变成了CMS foreground gc，它是并行full gc，只会执行cms中stop the world阶段的操作，效率比单线程Serial full GC要高；需要注意的是它只会回收old，因为cms收集器是老年代收集器；而正常的Serial收集是包含整个堆的，加入了参数<code>-XX:+ExplicitGCInvokesConcurrentAndUnloadsClasses</code>,代表永久带也会被cms收集；</td>
</tr>
<tr>
<td>-XX:+CMSParallelInitialMarkEnabled</td>
<td style="text-align:left">初始标记阶段是否采用多线程并行执行</td>
</tr>
<tr>
<td>- -XX:+PrintGCDetails</td>
<td style="text-align:left">日志详细打印参数</td>
</tr>
<tr>
<td>- -XX:+PrintGCCause</td>
<td style="text-align:left">日志详细打印参数</td>
</tr>
<tr>
<td>- -XX:+PrintGCTimeStamps</td>
<td style="text-align:left">日志详细打印参数</td>
</tr>
<tr>
<td>- -XX:+PrintGCDateStamps</td>
<td style="text-align:left">日志详细打印参数</td>
</tr>
<tr>
<td>- -Xloggc:../logs/gc.log</td>
<td style="text-align:left">日志详细打印参数</td>
</tr>
</tbody>
</table>
</div>
<h2><span id="日志分析">日志分析</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2017</span>-<span class="number">07</span>-<span class="number">27</span>T10:<span class="number">42</span>:<span class="number">56.291</span>-<span class="number">0800</span>: <span class="number">6.963</span>: [GC (CMS Final Remark)</span><br><span class="line">  [YG occupancy: <span class="number">199103</span> K (<span class="number">306688</span> K)]</span><br><span class="line">  <span class="number">2017</span>-<span class="number">07</span>-<span class="number">27</span>T10:<span class="number">42</span>:<span class="number">56.291</span>-<span class="number">0800</span>: <span class="number">6.963</span>: [Rescan (parallel) , <span class="number">0.0027865</span> secs]</span><br><span class="line">  <span class="number">2017</span>-<span class="number">07</span>-<span class="number">27</span>T10:<span class="number">42</span>:<span class="number">56.293</span>-<span class="number">0800</span>: <span class="number">6.966</span>: [weak refs processing, <span class="number">0.0000397</span> secs]</span><br><span class="line">  2017-07-27T10:42:56.294-0800: 6.966: [class unloading, 0.0004163 secs]</span><br><span class="line">  <span class="number">2017</span>-<span class="number">07</span>-<span class="number">27</span>T10:<span class="number">42</span>:<span class="number">56.294</span>-<span class="number">0800</span>: <span class="number">6.967</span>: [scrub symbol table, <span class="number">0.0006806</span> secs]</span><br><span class="line">  <span class="number">2017</span>-<span class="number">07</span>-<span class="number">27</span>T10:<span class="number">42</span>:<span class="number">56.295</span>-<span class="number">0800</span>: <span class="number">6.967</span>: [scrub string table, <span class="number">0.0001862</span> secs]</span><br><span class="line">  [<span class="number">1</span> CMS-remark: <span class="number">1569615</span>K(<span class="number">1756416</span>K)]</span><br><span class="line">  <span class="number">1768718</span>K(<span class="number">2063104</span>K),</span><br><span class="line"><span class="number">0.0043575</span> secs]</span><br><span class="line">[Times: user=<span class="number">0.01</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs]</span><br><span class="line"><span class="number">2017</span>-<span class="number">07</span>-<span class="number">27</span>T10:<span class="number">42</span>:<span class="number">56.291</span>-<span class="number">0800</span>: <span class="number">6.963</span>: [GC (CMS Final Remark（最终标记阶段，标记老年代中所有存活的对象，包括在此前的并发标记过程中创建/修改的引用）)</span><br><span class="line">  [YG occupancy: <span class="number">199103</span> K（当前年轻代的使用量） (<span class="number">306688</span> K（年轻代总大小）)]</span><br><span class="line">  <span class="number">2017</span>-<span class="number">07</span>-<span class="number">27</span>T10:<span class="number">42</span>:<span class="number">56.291</span>-<span class="number">0800</span>: <span class="number">6.963</span>: [Rescan (parallel) , <span class="number">0.0027865</span> secs]（在程序暂停时重新进行扫描，以完成存活对象的标记。此时 Rescan 是并行执行的）</span><br><span class="line">  <span class="number">2017</span>-<span class="number">07</span>-<span class="number">27</span>T10:<span class="number">42</span>:<span class="number">56.293</span>-<span class="number">0800</span>: <span class="number">6.966</span>: [weak refs processing, <span class="number">0.0000397</span> secs]（第一个子阶段，处理弱引用）</span><br><span class="line">  2017-07-27T10:42:56.294-0800: 6.966: [class unloading, 0.0004163 secs]（第二个子阶段，卸载不使用的类）</span><br><span class="line">  <span class="number">2017</span>-<span class="number">07</span>-<span class="number">27</span>T10:<span class="number">42</span>:<span class="number">56.294</span>-<span class="number">0800</span>: <span class="number">6.967</span>: [scrub symbol table, <span class="number">0.0006806</span> secs]</span><br><span class="line">  <span class="number">2017</span>-<span class="number">07</span>-<span class="number">27</span>T10:<span class="number">42</span>:<span class="number">56.295</span>-<span class="number">0800</span>: <span class="number">6.967</span>: [scrub string table, <span class="number">0.0001862</span> secs]（最后一个子阶段，清理持有 <span class="class"><span class="keyword">class</span> 级别 <span class="title">metadata</span> 的符号表，以及内部化字符串对应的 <span class="title">string</span> <span class="title">tables</span>）</span></span><br><span class="line">  [1 CMS-remark: 1569615K(1756416K)]（此阶段完成后老年代的使用量和总容量）</span><br><span class="line">  <span class="number">1768718</span>K(<span class="number">2063104</span>K),（此阶段完成后整个堆内存的使用量和总容量）</span><br><span class="line"><span class="number">0.0043575</span> secs]</span><br><span class="line">[Times: user=<span class="number">0.01</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs]</span><br></pre></td></tr></table></figure>
<h2><span id="cms-gc-分析">CMS gc 分析</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">/第一步 初始标记 这一步会停顿</span><br><span class="line">[GC (CMS Initial Mark) [<span class="number">1</span> CMS-initial-mark: <span class="number">299570</span>K(<span class="number">307200</span>K)] <span class="number">323315</span>K(<span class="number">491520</span>K), <span class="number">0.0026208</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs] </span><br><span class="line">         vmop                    [threads: total initially_running wait_to_block]    [time: spin block sync cleanup vmop] page_trap_count</span><br><span class="line"><span class="number">0.345</span>: CMS_Initial_Mark                 [      <span class="number">10</span>          <span class="number">0</span>              <span class="number">1</span>    ]      [     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">2</span>    ]  <span class="number">0</span>   </span><br><span class="line">Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">0.0028494</span> seconds</span><br><span class="line"></span><br><span class="line"><span class="comment">//第二步 并发标记</span></span><br><span class="line">[CMS-concurrent-mark-start]</span><br><span class="line">[CMS-concurrent-mark: <span class="number">0.012</span>/<span class="number">0.012</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.01</span> secs] </span><br><span class="line"></span><br><span class="line"><span class="comment">//第三步 预清理</span></span><br><span class="line">[CMS-concurrent-preclean-start]</span><br><span class="line">[CMS-concurrent-preclean: <span class="number">0.001</span>/<span class="number">0.001</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs] </span><br><span class="line"></span><br><span class="line"><span class="comment">//第四步 可被终止的预清理</span></span><br><span class="line">[CMS-concurrent-abortable-preclean-start]</span><br><span class="line">[CMS-concurrent-abortable-preclean: <span class="number">0.000</span>/<span class="number">0.000</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs] </span><br><span class="line"></span><br><span class="line"><span class="comment">//第五步 重新标记</span></span><br><span class="line">[GC (CMS Final Remark) [YG occupancy: 72704 K (184320 K)][Rescan (parallel) , 0.0009069 secs][weak refs processing, 0.0000083 secs][class unloading, 0.0002626 secs][scrub symbol table, 0.0003789 secs][scrub string table, 0.0001326 secs][1 CMS-remark: 299570K(307200K)] 372275K(491520K), 0.0017842 secs] [Times: user=0.05 sys=0.00, real=0.00 secs] </span><br><span class="line">         vmop                    [threads: total initially_running wait_to_block]    [time: spin block sync cleanup vmop] page_trap_count</span><br><span class="line"><span class="number">0.360</span>: CMS_Final_Remark                 [      <span class="number">10</span>          <span class="number">0</span>              <span class="number">1</span>    ]      [     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span>    ]  <span class="number">0</span>   </span><br><span class="line">Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">0.0018800</span> seconds</span><br><span class="line"><span class="comment">//第六步 清理</span></span><br><span class="line">[CMS-concurrent-sweep-start]</span><br><span class="line">[CMS-concurrent-sweep: <span class="number">0.007</span>/<span class="number">0.007</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.01</span> secs] </span><br><span class="line"></span><br><span class="line"><span class="comment">//第七步 重置</span></span><br><span class="line">[CMS-concurrent-reset-start]</span><br><span class="line">[CMS-concurrent-reset: <span class="number">0.002</span>/<span class="number">0.002</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs]</span><br></pre></td></tr></table></figure>
<p>CMS 的处理流程讲完了，由于篇幅有些长，分一下章节，下次会围绕CMS 的后续问题 展开一些讨论 欢迎阅读。</p>
<hr>
<h2><span id="参考">参考:</span></h2><p><a href="http://120.52.51.16/www.cs.virginia.edu/~cs415/reading/bacon-garbage.pdf" target="_blank" rel="noopener">垃圾回收统一理论</a><br><a href="http://www.math.grin.edu/~rebelsky/Courses/CS302/99S/Presentations/GC/" target="_blank" rel="noopener">Introduction to Garbage Collection</a><br><a href="https://hllvm-group.iteye.com/group/topic/38223" target="_blank" rel="noopener">R大：并发垃圾收集器（CMS）为什么没有采用标记-整理算法来实现？</a><br><a href="https://hllvm-group.iteye.com/group/topic/39402" target="_blank" rel="noopener">R大：请教Weak Reference及其在HotSpot GC中的行为? </a><br><a href="https://hllvm-group.iteye.com/group/topic/39402" target="_blank" rel="noopener">R大：请教Weak Reference及其在HotSpot GC中的行为? </a><br><a href="https://coldwalker.com/2019/02/gc_object_alloc_process/" target="_blank" rel="noopener">Java垃圾回收浅析(2)-GC方式介绍</a></p>

        
                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/article/java-cms-gc-log/" data-toggle="tooltip" data-placement="top" title="Java垃圾回收详解(6)">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/article/java-cms-gc-2/" data-toggle="tooltip" data-placement="top" title="Java垃圾回收详解(5)">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <br>

                <!--打赏-->
                
                    <div class="reward">
                        <div class="reward-button">赏 <span class="reward-code"> 
                            <span class="alipay-code"> <img class="alipay-img" src="alipay_url"><b>支付宝打赏</b></span> 
                            <span class="wechat-code"> <img class="wechat-img" src="wechatpay_url"><b>微信打赏</b> </span>
                            </span></div>
                        <p class="reward-notice">赞赏一下</p>
                    </div>
                
                <!--打赏-->

                <br>
                <!--分享-->
                
                    <div class="social-share"  data-wechat-qrcode-helper="" align="center"></div>
                    <!--  css & js -->
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>
                
                <!--分享-->
                <br>                       
                
                <!-- require APlayer -->
                

                <!-- duoshuo Share start -->
                
                <!-- 多说 Share end-->

                <!-- 多说评论框 start -->
                
                <!-- 多说评论框 end -->

                <!-- disqus comment start -->
                
                <!-- disqus comment end -->

                

            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

  
    <style>
      span.toc-nav-number{
        display: none
      }
    </style>
  
    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">CMS 垃圾回收器简介</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">CMS 过程详解</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">CMS收集器的7个阶段：</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">CMS 阶段详解</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">4.1.</span> <span class="toc-nav-text">初始标记（Idling）阶段</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">4.2.</span> <span class="toc-nav-text">并发标记 （InitialMarking）阶段</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">4.3.</span> <span class="toc-nav-text">预清理 （Precleaning） 阶段</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">4.4.</span> <span class="toc-nav-text">可中断的预清理（AbortablePreclean）阶段</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">4.5.</span> <span class="toc-nav-text">重新标记（FinalMarking）</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">4.6.</span> <span class="toc-nav-text">并发清理 （ CMS-concurrent-sweep ）</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">4.7.</span> <span class="toc-nav-text">并发重置 （ CMS-concurrent-reset ）</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">CMS 调优</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">6.</span> <span class="toc-nav-text">CMS JVM 参数</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">7.</span> <span class="toc-nav-text">日志分析</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">8.</span> <span class="toc-nav-text">CMS gc 分析</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">9.</span> <span class="toc-nav-text">参考:</span></a></li></ol>
        
        </div>
      </aside>
    

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#JAVA" title="JAVA">JAVA</a>
                        
                          <a class="tag" href="/tags/#JVM" title="JVM">JVM</a>
                        
                          <a class="tag" href="/tags/#垃圾回收篇" title="垃圾回收篇">垃圾回收篇</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                </ul>
                
            </div>
        </div>
    </div>
</article>








<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'ℬ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>

<!-- chrome Firefox 中文锚点定位失效-->
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
<!-- smooth scroll behavior polyfill  -->
<script type="text/javascript" src="/js/smoothscroll.js"></script>
<script>
        $('#toc').on('click','a.toc-nav-text',function(a){
            document.getElementById(a.target.innerText.replace(/\s/g,'').replace(/\./g,'-').toLowerCase()).scrollIntoView(true);
            document.getElementById($(a.currentTarget).attr("href").replace("#","")).scrollIntoView({behavior: 'smooth' });
        })  
</script>


    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/u/2028033763">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/IceFrozen">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Jason Lee 2020 
                    <br>
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    re-Ported by <a href="#">JasonLess</a> | 
                    <!-- <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="#" >
                    </iframe> -->
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>

<!-- Custom Theme search -->
<script src="/js/search.js"></script>
<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("http://yoursite.com/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-XXXXXXXX-X';
    var _gaDomain = 'yoursite';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>



<!-- search code -->

    <script type="text/javascript">      
      var search_path = "search.xml";
      if (search_path.length == 0) {
          search_path = "search.xml";
      }
      var path = "/" + search_path;
      searchFunc(path, 'local-search-input', 'local-search-result');
    </script>
 

<!-- Baidu Tongji -->

<script>
    // dynamic User by Hux
    var _baId = 'xxx';

    // Originial
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?" + _baId;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
</script>






	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>
<!-- Image to hack wechat -->
<img src="http://yoursite.com/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work --><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</body>

</html>
